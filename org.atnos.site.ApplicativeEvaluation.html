<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Applicative</title>
    <link href="./images/s2.ico"                                   type="image/x-icon" rel="specs2 icon"/>
    <link href="./css/opensans-fonts.css"                          type="text/css"     rel="stylesheet" />
    <link href="./css/bootstrap.min.css"                           type="text/css"     rel="stylesheet" />
    <link href="./css/font-awesome.min.css"                        type="text/css"     rel="stylesheet" />
    <link href="./css/prettify.css"                                type="text/css"     rel="stylesheet" />
    <link href="./css/tabber.css"                                  type="text/css"     rel="stylesheet" />
    <link href="./css/tipuesearch.css"                             type="text/css"     rel="stylesheet" />
    <link href="./css/specs2.css"                                  type="text/css"     rel="stylesheet" />
    <link href="./css/specs2-user.css"                             type="text/css"     rel="stylesheet" />

    <script src="./javascript/jquery.js"                           type="text/javascript"></script>
    <script src="./javascript/jquery.jstree.js"                    type="text/javascript"></script>
    <script src="./javascript/tabber.js"                           type="text/javascript"></script>
    <script src="./javascript/tabber_start.js"                     type="text/javascript"></script>
    <script src="./javascript/prettify.js"                         type="text/javascript"></script>
    <script src="./javascript/specs2.js"                           type="text/javascript"></script>
    <script src="./javascript/specs2-user.js"                      type="text/javascript"></script>
    <script src="./javascript/tipuesearch/tipuesearch_set.js"      type="text/javascript"></script>
    <script src="./javascript/tipuesearch/tipuesearch_contents.js" type="text/javascript"></script>
    <script src="./javascript/tipuesearch/tipuesearch.min.js"      type="text/javascript"></script>

</head>
<body onload="prettyPrint(); tabberAutomatic([])">

<div class="container">

<div class="col-md-2 col-sm-3 col-xs-3 sidebar-outer">
<div class="col-md-2 fixed">

<!-- search box -->
<div class="search-box">
  <form action="search.html">
    <input type="text" name="q" id="tipue_search_input" autocomplete="off" required>
  </form>
</div>

<!-- table of contents -->
<div id="tree"><ul>
                <li id="index"><a href="index.html" title="eff">eff</a>
      <ul><ul><li><a href="index.html#contributing" title="Contributing">Contributing</a>
          
        </li></ul></ul>
      <ul>
                    <ul>
                <li id="org-atnos-site-installation"><a href="org.atnos.site.Installation.html" title="Installation">Installation</a>
      <ul><ul><li><a href="org.atnos.site.Installation.html#additional-dependencies" title="Additional dependencies">Additional depe...</a>
          
        </li><li><a href="org.atnos.site.Installation.html#imports" title="Imports">Imports</a>
          <ul><li><a href="org.atnos.site.Installation.html#main-types" title="Main types">Main types</a>
          
        </li><li><a href="org.atnos.site.Installation.html#creating-effects" title="Creating effects">Creating effects</a>
          
        </li><li><a href="org.atnos.site.Installation.html#interpreting-effects" title="Interpreting effects">Interpreting ef...</a>
          
        </li><li><a href="org.atnos.site.Installation.html#intellij-support" title="Intellij support">Intellij support</a>
          
        </li><li><a href="org.atnos.site.Installation.html#with-scalaz" title="With Scalaz">With Scalaz</a>
          
        </li></ul>
        </li></ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-introduction"><a href="org.atnos.site.Introduction.html" title="Introduction">Introduction</a>
      <ul><ul><li><a href="org.atnos.site.Introduction.html#first-example" title="First example">First example</a>
          
        </li></ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-outofthebox"><a href="org.atnos.site.OutOfTheBox.html" title="Out of the box">Out of the box</a>
      <ul><ul><li><a href="org.atnos.site.OutOfTheBox.html#what’s-next?" title="What’s next?">What’s next?</a>
          
        </li></ul></ul>
      <ul>
                    <ul>
                <li id="org-atnos-site-lib-evaleffectpage"><a href="org.atnos.site.lib.EvalEffectPage.html" title="Eval">Eval</a>
      <ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-lib-optioneffectpage"><a href="org.atnos.site.lib.OptionEffectPage.html" title="Option">Option</a>
      <ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-lib-eithereffectpage"><a href="org.atnos.site.lib.EitherEffectPage.html" title="Either">Either</a>
      <ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-lib-validateeffectpage"><a href="org.atnos.site.lib.ValidateEffectPage.html" title="Validate">Validate</a>
      <ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-lib-erroreffectpage"><a href="org.atnos.site.lib.ErrorEffectPage.html" title="Error">Error</a>
      <ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-lib-readereffectpage"><a href="org.atnos.site.lib.ReaderEffectPage.html" title="Reader">Reader</a>
      <ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-lib-writereffectpage"><a href="org.atnos.site.lib.WriterEffectPage.html" title="Writer">Writer</a>
      <ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-lib-stateeffectpage"><a href="org.atnos.site.lib.StateEffectPage.html" title="State">State</a>
      <ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-lib-listeffectpage"><a href="org.atnos.site.lib.ListEffectPage.html" title="List">List</a>
      <ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-lib-chooseeffectpage"><a href="org.atnos.site.lib.ChooseEffectPage.html" title="Choose">Choose</a>
      <ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-lib-memoeffectpage"><a href="org.atnos.site.lib.MemoEffectPage.html" title="Memo">Memo</a>
      <ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-lib-timedfutureeffectpage"><a href="org.atnos.site.lib.TimedFutureEffectPage.html" title="TimedFuture">TimedFuture</a>
      <ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-lib-taskeffectpage"><a href="org.atnos.site.lib.TaskEffectPage.html" title="Task">Task</a>
      <ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-lib-safeeffectpage"><a href="org.atnos.site.lib.SafeEffectPage.html" title="Safe">Safe</a>
      <ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul>
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-tutorial"><a href="org.atnos.site.Tutorial.html" title="Tutorial">Tutorial</a>
      <ul><ul><li><a href="org.atnos.site.Tutorial.html#study-your-topic" title="Study your topic">Study your topic</a>
          
        </li><li><a href="org.atnos.site.Tutorial.html#create-an-adt
representing-your-grammar" title="Create an ADT
representing your grammar">Create an ADT
r...</a>
          
        </li><li><a href="org.atnos.site.Tutorial.html#free-your-adt" title="Free your ADT">Free your ADT</a>
          
        </li><li><a href="org.atnos.site.Tutorial.html#create-smart
constructors-using-eff.send" title="Create smart
constructors using Eff.send">Create smart
co...</a>
          
        </li><li><a href="org.atnos.site.Tutorial.html#build-a-program" title="Build a program">Build a program</a>
          
        </li><li><a href="org.atnos.site.Tutorial.html#write-an-interpreter-for
your-program" title="Write an interpreter for
your program">Write an interp...</a>
          
        </li><li><a href="org.atnos.site.Tutorial.html#run-your-program" title="Run your program">Run your program</a>
          
        </li><li><a href="org.atnos.site.Tutorial.html#add-some-syntax" title="Add some syntax">Add some syntax</a>
          
        </li><li><a href="org.atnos.site.Tutorial.html#composing-adts-with-the-eff
monad" title="Composing ADTs with the Eff
monad">Composing ADTs ...</a>
          
        </li></ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-createeffects"><a href="org.atnos.site.CreateEffects.html" title="Creating effects">Creating effects</a>
      <ul><ul><li><a href="org.atnos.site.CreateEffects.html#creation" title="Creation">Creation</a>
          
        </li><li><a href="org.atnos.site.CreateEffects.html#compiler-limitation" title="Compiler limitation">Compiler limita...</a>
          
        </li><li><a href="org.atnos.site.CreateEffects.html#interpreter" title="Interpreter">Interpreter</a>
          
        </li></ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-transformstack"><a href="org.atnos.site.TransformStack.html" title="Transform stacks">Transform stacks</a>
      <ul><ul><li><a href="org.atnos.site.TransformStack.html#what-is-an-“effect-stack”?" title="What is an “effect stack”?">What is an “eff...</a>
          
        </li><li><a href="org.atnos.site.TransformStack.html#transform-an-effect-to
another" title="Transform an effect to
another">Transform an ef...</a>
          <ul><li><a href="org.atnos.site.TransformStack.html#change-the-effect" title="Change the effect">Change the effect</a>
          
        </li></ul>
        </li><li><a href="org.atnos.site.TransformStack.html#translate-an-effect
into-multiple-others" title="Translate an effect
into multiple others">Translate an ef...</a>
          
        </li><li><a href="org.atnos.site.TransformStack.html#interpret-an-effect-“locally”" title="Interpret an effect “locally”">Interpret an ef...</a>
          
        </li><li><a href="org.atnos.site.TransformStack.html#merge-stacks" title="Merge stacks">Merge stacks</a>
          
        </li></ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-memberimplicits"><a href="org.atnos.site.MemberImplicits.html" title="Member implicits">Member implicits</a>
      <ul><ul><li><a href="org.atnos.site.MemberImplicits.html#running-effects
with-several-type-parameters" title="Running effects
with several type parameters">Running effects...</a>
          
        </li><li><a href="org.atnos.site.MemberImplicits.html#use-context-bounds-and-type
aliases" title="Use context bounds and type
aliases">Use context bou...</a>
          
        </li><li><a href="org.atnos.site.MemberImplicits.html#know-your-member
typeclasses" title="Know your Member
typeclasses">Know your Membe...</a>
          
        </li><li><a href="org.atnos.site.MemberImplicits.html#“packing”-member-instances" title="“Packing” member instances">“Packing” membe...</a>
          
        </li></ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-applicativeevaluation"><a href="org.atnos.site.ApplicativeEvaluation.html" title="Applicative">Applicative</a>
      <ul><ul><li><a href="org.atnos.site.ApplicativeEvaluation.html#concurrent-evaluation" title="Concurrent evaluation">Concurrent eval...</a>
          
        </li><li><a href="org.atnos.site.ApplicativeEvaluation.html#batching" title="Batching">Batching</a>
          
        </li></ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-cookbook"><a href="org.atnos.site.Cookbook.html" title="Cookbook">Cookbook</a>
      <ul><ul><li><a href="org.atnos.site.Cookbook.html#partial-interpretation" title="Partial Interpretation">Partial Interpr...</a>
          
        </li></ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-communityresources"><a href="org.atnos.site.CommunityResources.html" title="Community resources">Community resou...</a>
      <ul><ul><li><a href="org.atnos.site.CommunityResources.html#blog-posts" title="Blog posts">Blog posts</a>
          
        </li><li><a href="org.atnos.site.CommunityResources.html#tutorials-&amp;-examples" title="Tutorials &amp; Examples">Tutorials &amp; Exa...</a>
          
        </li></ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul>
                  </ul>
    </li>
              </ul></div><script>$(function () { $('#tree').jstree({'core':{'initially_open':['index','org-atnos-site-applicativeevaluation'], 'animation':200}, 'themes' : {'theme': 'default','url': './css/themes/default/style.css'}, 'plugins':['themes', 'html_data']}); });</script>

</div>
</div>


<div class="col-md-10 col-sm-9 col-xs-9">
<h1>Applicative</h1>
<div id="tipue_search_content"></div>

<h3 id="concurrent-evaluation">Concurrent evaluation</h3>
<p>The default interpretation of <code class="prettyprint">Eff</code> values is “monadic”
meaning that effectful values are being evaluated in order. This becomes
clear when traversing a list of values with the
<code class="prettyprint">FutureEffect</code>:</p>
<pre><code class="prettyprint">import org.atnos.eff._, all._, future._, syntax.all._
      import cats.Eval
      import cats.data.Writer
      import cats.syntax.traverse._
      import cats.instances.list._
      import scala.concurrent._, duration._, ExecutionContext.Implicits.global
      import org.atnos.eff.concurrent.Scheduler
      import org.atnos.eff.syntax.future._

      type WriterString[A] = Writer[String, A]
      type _writerString[R] = WriterString |= R

      type S = Fx.fx3[Eval, TimedFuture, WriterString]

      implicit val scheduler: Scheduler = ExecutorServices.schedulerFromGlobalExecutionContext

      def execute[E: _eval: _writerString: _future](i: Int): Eff[E, Int] =
        for {
          i1 &lt;- delay(i)
          i2 &lt;- futureDelay(i1)
          _ &lt;- tell(i2.toString)
        } yield i2

      val action: Eff[S, List[Int]] =
        List(1000, 500, 50).traverse(execute[S])

      Await.result(action.runEval.runWriterLog.runSequential, 2.seconds)</code></pre>
<p><code class="prettyprint">&gt; List(1000, 500, 50)</code></p>
<p>We can however run all those computations concurrently using the
applicative execution for <code class="prettyprint">Eff</code>:</p>
<pre><code class="prettyprint">      val action: Eff[S, List[Int]] =
        List(1000, 500, 50).traverseA(execute[S])

      Await.result(
        Eff.detachA(action.runEval.runWriterLog[String])(TimedFuture.MonadTimedFuture, TimedFuture.ApplicativeTimedFuture).runNow(scheduler, global),
        2.seconds
      )</code></pre>
<p><code class="prettyprint">&gt; List(1000, 500, 50)</code></p>
<p>This uses now <code class="prettyprint">traverseA</code> (instead of
<code class="prettyprint">traverse</code>) to do an applicative traversal and execute
futures concurrently and the fastest actions finish first.</p>
<h3 id="batching">Batching</h3>
<p>Another advantage of applicative effects is that we can intercept
them individual requests and “batch” them into one single request. For
example:</p>
<pre><code class="prettyprint">import org.atnos.eff._, all._, syntax.all._

// An effect to get users from a database
// calls can be individual or batched
      case class User(i: Int)
      sealed trait UserDsl[+A]

      case class GetUser(i: Int) extends UserDsl[User]
      case class GetUsers(is: List[Int]) extends UserDsl[List[User]]
      type _userDsl[R] = UserDsl /= R

      def getUser[R: _userDsl](i: Int): Eff[R, User] =
        send[UserDsl, R, User](GetUser(i))

</code></pre>
<p>Let’s create an interpreter for this DSL:</p>
<pre><code class="prettyprint">// the real method calls to a webservice
      def getWebUser(i: Int): User = User(i)
      def getWebUsers(is: List[Int]): List[User] = is.map(i =&gt; User(i))

// the interpreter simply calls the webservice
// and return a trace of the executed call
      def runDsl[A](eff: Eff[Fx1[UserDsl], A]): (A, Vector[String]) = {
        @tailrec
        def go(e: Eff[Fx1[UserDsl], A], trace: Vector[String]): (A, Vector[String]) =
          e match {
            case Pure(a, _) =&gt; (a, trace)
            case Impure(UnionTagged(GetUser(i), _), c, _) =&gt; go(c(getWebUser(i)), trace :+ &quot;getWebUser&quot;)
            case Impure(UnionTagged(GetUsers(is), _), c, _) =&gt; go(c(getWebUsers(is)), trace :+ &quot;getWebUsers&quot;)
            case ap @ ImpureAp(_, _, _) =&gt; go(ap.toMonadic, trace)
            case Impure(_, _, _) =&gt; sys.error(&quot;this should not happen with just one effect&quot;)
          }
        go(eff, Vector())
      }

</code></pre>
<p>We can also optimise a <code class="prettyprint">UserDsl</code> program by providing a
<code class="prettyprint">Batchable</code> instance describing how to “batch” 2 calls into
1:</p>
<pre><code class="prettyprint">      implicit def BatchableUserDsl: Batchable[UserDsl] = new Batchable[UserDsl] {
        type Z = List[User]
        type E = User

        def distribute(z: List[User]) = z

        def batch[X, Y](tx: UserDsl[X], ty: UserDsl[Y]): Option[UserDsl[Z]] = Option {
          (tx, ty) match {
            case (GetUser(i), GetUser(j)) =&gt; GetUsers(List(i, j))
            case (GetUser(i), GetUsers(is)) =&gt; GetUsers(i :: is)
            case (GetUsers(is), GetUser(i)) =&gt; GetUsers(is :+ i)
            case (GetUsers(is), GetUsers(js)) =&gt; GetUsers(is ++ js)
          }
        }
      }

</code></pre>
<p>Now let’s create a program using the <code class="prettyprint">User</code> DSL with
applicative calls which can be optimised:</p>
<pre><code class="prettyprint">      def program[R: _userDsl]: Eff[R, List[User]] =
        Eff.traverseA(List(1, 2, 3))(i =&gt; getUser(i))

</code></pre>
<p>And its optimised version:</p>
<pre><code class="prettyprint">      def optimised[R: _userDsl]: Eff[R, List[User]] =
        program.batch

</code></pre>
<p>Running the optimised and non-optimised version of the program must
yield the same results:</p>
<pre><code class="prettyprint">      show(runDsl(program[Fx1[UserDsl]]), runDsl(optimised[Fx1[UserDsl]]))</code></pre>
<pre><code class="prettyprint">original:  User(1), User(2), User(3)
  trace: getWebUser, getWebUser, getWebUser

optimised: User(1), User(2), User(3)
  trace: getWebUsers</code></pre>
</div>

<script>
$(document).ready(function() {
  $('#tipue_search_input').tipuesearch({
    'show': 6
  });
});
</script>
</div>

</body>
</html>